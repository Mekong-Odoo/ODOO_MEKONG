name: ğŸ” CI Check on develop

on:
  pull_request:
    branches: [develop]

jobs:
  check_odoo:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Láº¥y source code
        uses: actions/checkout@v4

      - name: ğŸ CÃ i Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: ğŸ“¦ CÃ i dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip postgresql-client
          pip install flake8 pylint

      - name: ğŸ§ª Cháº¡y flake8 kiá»ƒm tra code (addons + custom_modules)
        id: flake8_check
        run: |
          echo "ğŸ” Kiá»ƒm tra flake8..."
          mkdir -p reports
          flake8 ./server/addons ./server/custom_modules \
            --exclude=*/migrations/*,*/__pycache__/* \
            --max-line-length=88 \
            --output-file=reports/flake8_errors.txt || true
          if [ -s reports/flake8_errors.txt ]; then
            echo "has_flake8_errors=true" >> $GITHUB_OUTPUT
          else
            echo "has_flake8_errors=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“ Táº¡o file .env tá»« GitHub Secrets
        run: |
          cd server
          cat <<EOF > .env
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_NAME=${{ secrets.DB_NAME }}
          ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}
          FILESTORE_PATH=${{ secrets.FILESTORE_PATH }}
          EOF

      # ThÃªm step Ä‘á»ƒ thiáº¿t láº­p Docker buildx
      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”§ CÃ i Ä‘áº·t Docker Compose
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/download/v2.29.7/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose --version

      # ThÃªm step Ä‘á»ƒ pull base image trÆ°á»›c
      - name: ğŸ³ Pull base Odoo image
        run: |
          docker pull odoo:18.0

      - name: ğŸ³ Build vÃ  cháº¡y Odoo container vá»›i retry logic
        id: docker_build
        run: |
          echo "ğŸš€ Cháº¡y Docker build/test..."
          cd server
          
          # Cleanup trÆ°á»›c khi báº¯t Ä‘áº§u
          docker-compose down -v --remove-orphans 2>/dev/null || true
          docker system prune -f 2>/dev/null || true
          
          # Build vá»›i retry logic
          for i in {1..3}; do
            echo "ğŸ”¨ Build attempt $i..."
            if docker-compose build --no-cache --pull; then
              echo "âœ… Build thÃ nh cÃ´ng!"
              break
            else
              echo "âŒ Build failed attempt $i"
              if [ "$i" -eq 3 ]; then
                echo "ğŸ’¥ Build failed sau 3 láº§n thá»­!"
                exit 1
              fi
              sleep 30
            fi
          done
          
          # Start services
          docker-compose up -d
          
          # Äá»£i container khá»Ÿi Ä‘á»™ng
          echo "â³ Äá»£i Odoo khá»Ÿi Ä‘á»™ng..."
          sleep 90
          
          # Kiá»ƒm tra container status
          docker ps > reports/docker_ps.txt
          
          # Kiá»ƒm tra logs ngay láº­p tá»©c
          docker logs odoo_app > reports/startup_logs.txt 2>&1 || true

      - name: ğŸ” Láº¥y log Odoo tá»« container vá»›i timeout
        id: health_check
        timeout-minutes: 5
        run: |
          echo "ğŸ“¦ Ghi log Odoo..."
          mkdir -p reports
          
          # Láº¥y logs vá»›i timeout
          timeout 240s docker logs -f odoo_app > reports/odoo_full_logs.txt 2>&1 &
          
          # Äá»£i má»™t chÃºt Ä‘á»ƒ logs Ä‘Æ°á»£c ghi
          sleep 60
          
          # Láº¥y log tá»« file log trong container (náº¿u cÃ³)
          docker exec odoo_app tail -n 100 /var/log/odoo/odoo.log > reports/odoo_tail_100.txt 2>/dev/null || \
          docker logs odoo_app --tail=100 > reports/odoo_tail_100.txt 2>&1
          
          # Kiá»ƒm tra lá»—i trong logs
          if grep -Ei "ERROR|CRITICAL|Traceback|Exception|Failed" reports/odoo_tail_100.txt > reports/log_errors.txt 2>/dev/null; then
            echo "has_log_errors=true" >> $GITHUB_OUTPUT
          else
            echo "has_log_errors=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸŒ Kiá»ƒm tra Odoo service vá»›i retry
        id: service_check
        run: |
          echo "ğŸ” Kiá»ƒm tra káº¿t ná»‘i Odoo..."
          
          # Kiá»ƒm tra container cÃ³ Ä‘ang cháº¡y khÃ´ng
          if ! docker ps | grep odoo_app; then
            echo "âŒ Container khÃ´ng cháº¡y!"
            echo "service_available=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Thá»­ káº¿t ná»‘i vá»›i retry logic
          for i in {1..15}; do
            echo "ğŸ”„ Thá»­ káº¿t ná»‘i láº§n $i/15..."
            
            # Kiá»ƒm tra multiple endpoints
            if curl -sSf --connect-timeout 10 --max-time 30 http://localhost:8069/ > /dev/null 2>&1 || \
               curl -sSf --connect-timeout 10 --max-time 30 http://localhost:8069/web/database/selector > /dev/null 2>&1; then
              echo "âœ… Odoo Ä‘Ã£ sáºµn sÃ ng!"
              echo "service_available=true" >> $GITHUB_OUTPUT
              break
            fi
            
            if [ "$i" -eq 15 ]; then
              echo "âŒ KhÃ´ng thá»ƒ káº¿t ná»‘i Ä‘áº¿n Odoo sau 15 láº§n thá»­"
              echo "service_available=false" >> $GITHUB_OUTPUT
              # Láº¥y thÃªm thÃ´ng tin debug
              docker exec odoo_app ps aux > reports/container_processes.txt 2>/dev/null || true
              docker exec odoo_app netstat -tlnp > reports/container_ports.txt 2>/dev/null || true
            else
              sleep 40
            fi
          done

      - name: ğŸ§¹ Cleanup Docker
        if: always()
        run: |
          echo "ğŸ§¹ Dá»n dáº¹p Docker..."
          cd server || true
          docker-compose logs odoo > reports/final_logs.txt 2>&1 || true
          docker-compose down -v --remove-orphans 2>/dev/null || true
          docker system prune -f 2>/dev/null || true

      - name: ğŸ“‹ Táº¡o bÃ¡o cÃ¡o CI tá»•ng há»£p
        if: always()
        run: |
          echo "## ğŸ“Š CI Check Results" >> reports/ci_summary.txt
          echo "- **Flake8 Check**: ${{ steps.flake8_check.outputs.has_flake8_errors == 'true' && 'âŒ CÃ³ lá»—i' || 'âœ… Passed' }}" >> reports/ci_summary.txt
          echo "- **Docker Build**: ${{ steps.docker_build.outcome == 'success' && 'âœ… Success' || 'âŒ Failed' }}" >> reports/ci_summary.txt
          echo "- **Log Odoo**: ${{ steps.health_check.outputs.has_log_errors == 'true' && 'âŒ CÃ³ lá»—i' || 'âœ… Clean' }}" >> reports/ci_summary.txt
          echo "- **Service Check**: ${{ steps.service_check.outputs.service_available == 'true' && 'âœ… OK' || 'âŒ KhÃ´ng pháº£n há»“i' }}" >> reports/ci_summary.txt
          
          echo "" >> reports/ci_summary.txt
          echo "### ğŸ”§ Debug Information" >> reports/ci_summary.txt
          echo "- Docker Version: $(docker --version)" >> reports/ci_summary.txt
          echo "- Docker Compose Version: $(docker-compose --version)" >> reports/ci_summary.txt
          echo "- Build Time: $(date)" >> reports/ci_summary.txt

      - name: ğŸ“§ Gá»­i email káº¿t quáº£ CI
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: ${{ job.status == 'success' && 'âœ… CI PASSED' || 'âŒ CI FAILED' }} - PR #${{ github.event.number }}
          to: ${{ secrets.USER_CI_NOTIFY }}
          from: "Odoo CI Bot <${{ secrets.SMTP_USERNAME }}>"
          body: |
            Xin chÃ o,

            CI Ä‘Ã£ cháº¡y trÃªn PR #${{ github.event.number }}: "${{ github.event.pull_request.title }}"
            - TÃ¡c giáº£: ${{ github.event.pull_request.user.login }}
            - Branch: ${{ github.head_ref }} â†’ develop
            - Commit: ${{ github.sha }}

            **Káº¿t quáº£ tá»•ng há»£p:**
            - Flake8: ${{ steps.flake8_check.outputs.has_flake8_errors == 'true' && 'âŒ CÃ³ lá»—i' || 'âœ… Passed' }}
            - Docker Build: ${{ steps.docker_build.outcome == 'success' && 'âœ… Success' || 'âŒ Failed' }}
            - Log Odoo: ${{ steps.health_check.outputs.has_log_errors == 'true' && 'âŒ CÃ³ lá»—i' || 'âœ… Clean' }}
            - Odoo Service: ${{ steps.service_check.outputs.service_available == 'true' && 'âœ… OK' || 'âŒ KhÃ´ng pháº£n há»“i' }}

            ${{ job.status != 'success' && 'âš ï¸ Vui lÃ²ng kiá»ƒm tra vÃ  sá»­a lá»—i trÆ°á»›c khi merge.' || 'ğŸš€ Sáºµn sÃ ng merge!' }}

            Link PR: ${{ github.event.pull_request.html_url }}

            TrÃ¢n trá»ng,  
            Odoo CI Bot ğŸ¤–
          attachments: reports/flake8_errors.txt,reports/log_errors.txt,reports/odoo_tail_50.txt,reports/ci_summary.txt,reports/docker_ps.txt
