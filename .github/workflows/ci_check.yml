name: ğŸ” CI Check on develop

on:
  pull_request:
    branches: [develop]
    types: [opened, synchronize, reopened]

# Prevent concurrent runs on same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check_odoo:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ğŸ“¥ Láº¥y source code
        uses: actions/checkout@v4

      # Cache vá»›i key stable hÆ¡n
      - name: ğŸ Setup Python 3.12 vá»›i pip cache
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: ğŸ“ Táº¡o thÆ° má»¥c reports
        run: mkdir -p reports

      # Simplified apt installation - khÃ´ng cache apt
      - name: ğŸ“¦ CÃ i system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y python3-pip postgresql-client

      # Cache pip vá»›i hash cá»§a workflow nÃ y
      - name: ğŸ“¦ Cache Python packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('.github/workflows/ci_check.yml') }}-v1
          restore-keys: |
            pip-${{ runner.os }}-

      - name: ğŸ“¦ CÃ i Python dependencies
        run: |
          pip install --no-deps flake8 pylint
          echo "âœ… Python packages installed"

      - name: ğŸ§ª Cháº¡y flake8 kiá»ƒm tra code (addons + custom_modules)
        id: flake8_check
        run: |
          echo "ğŸ” Kiá»ƒm tra flake8..."
          flake8 ./server/addons ./server/custom_modules \
            --exclude=*/migrations/*,*/__pycache__/* \
            --max-line-length=88 \
            --output-file=reports/flake8_errors.txt || true
          if [ -s reports/flake8_errors.txt ]; then
            echo "has_flake8_errors=true" >> $GITHUB_OUTPUT
          else
            echo "has_flake8_errors=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“ Táº¡o file .env tá»« GitHub Secrets
        run: |
          cd server
          cat <<EOF > .env
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_NAME=${{ secrets.DB_NAME }}
          ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}
          FILESTORE_PATH=${{ secrets.FILESTORE_PATH }}
          EOF

      # Docker Compose - simple approach
      - name: ğŸ”§ Setup Docker Compose
        run: |
          # Check if already exists
          if [ -f ~/.docker/cli-plugins/docker-compose ]; then
            echo "âœ… Docker Compose already exists"
            ~/.docker/cli-plugins/docker-compose version
          else
            echo "ğŸ“¥ Installing Docker Compose v2.27.1..."
            DOCKER_COMPOSE_VERSION="v2.27.1" 
            mkdir -p ~/.docker/cli-plugins
            curl -SL "https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-linux-x86_64" -o ~/.docker/cli-plugins/docker-compose
            chmod +x ~/.docker/cli-plugins/docker-compose
            echo "âœ… Docker Compose installed"
            ~/.docker/cli-plugins/docker-compose version
          fi

      # Cache Docker layers
      - name: ğŸ³ Setup Docker Buildx vá»›i cache
        uses: docker/setup-buildx-action@v3

      - name: ğŸ³ Build vÃ  cháº¡y Odoo container
        id: docker_build
        run: |
          echo "ğŸš€ Cháº¡y Docker build/test..."
          cd server
          ~/.docker/cli-plugins/docker-compose down -v || true
          
          # Build vá»›i cache
          ~/.docker/cli-plugins/docker-compose build --parallel
          ~/.docker/cli-plugins/docker-compose up -d
          
          # TÄƒng thá»i gian chá» vÃ  kiá»ƒm tra container status
          echo "â³ Chá» containers khá»Ÿi Ä‘á»™ng..."
          sleep 30
          
          # Kiá»ƒm tra container cÃ³ cháº¡y khÃ´ng
          for i in {1..6}; do
            if ~/.docker/cli-plugins/docker-compose ps | grep -q "Up"; then
              echo "âœ… Containers Ä‘ang cháº¡y"
              break
            fi
            echo "â³ Chá» containers... ($i/6)"
            sleep 30
          done
          
          mkdir -p ../reports
          ~/.docker/cli-plugins/docker-compose ps > ../reports/docker_ps.txt

      - name: ğŸ” Láº¥y log Odoo tá»« container
        id: health_check
        run: |
          echo "ğŸ“¦ Ghi log Odoo..."
          cd server
          
          # Kiá»ƒm tra container cÃ³ Ä‘ang cháº¡y khÃ´ng
          if ! ~/.docker/cli-plugins/docker-compose ps | grep -q "odoo_app.*Up"; then
            echo "âŒ Container odoo_app khÃ´ng cháº¡y hoáº·c unhealthy"
            echo "has_log_errors=true" >> $GITHUB_OUTPUT
            ~/.docker/cli-plugins/docker-compose logs > ../reports/docker_compose_logs.txt 2>&1 || true
            echo "Container odoo_app khÃ´ng cháº¡y" > ../reports/log_errors.txt
            exit 0
          fi
          
          # Láº¥y logs vá»›i timeout
          timeout 60 ~/.docker/cli-plugins/docker-compose logs odoo_app > ../reports/odoo_full_logs.txt 2>&1 || true
          
          # Láº¥y log cuá»‘i
          ~/.docker/cli-plugins/docker-compose logs --tail 50 odoo_app > ../reports/odoo_tail_50.txt 2>&1 || true
          
          if [ -f ../reports/odoo_tail_50.txt ] && grep -Ei "ERROR|CRITICAL|Traceback|Exception" ../reports/odoo_tail_50.txt > ../reports/log_errors.txt; then
            echo "has_log_errors=true" >> $GITHUB_OUTPUT
          else
            echo "has_log_errors=false" >> $GITHUB_OUTPUT
            touch ../reports/log_errors.txt
          fi

      # Thay tháº¿ kiá»ƒm tra HTTP báº±ng nhiá»u phÆ°Æ¡ng phÃ¡p
      - name: ğŸŒ Kiá»ƒm tra Odoo service (Multiple methods)
        id: service_check
        run: |
          cd server
          service_available=false
          
          # Táº¡o debug info file trÆ°á»›c (luÃ´n cÃ³ file nÃ y)
          echo "=== ODOO SERVICE DEBUG INFO ===" > ../reports/debug_info.txt
          echo "Timestamp: $(date)" >> ../reports/debug_info.txt
          echo "Runner: GitHub Actions Ubuntu" >> ../reports/debug_info.txt
          echo "" >> ../reports/debug_info.txt
          
          echo "ğŸ” PhÆ°Æ¡ng phÃ¡p 1: Kiá»ƒm tra container health"
          echo "=== Container Status ===" >> ../reports/debug_info.txt
          ~/.docker/cli-plugins/docker-compose ps >> ../reports/debug_info.txt 2>&1 || true
          if ~/.docker/cli-plugins/docker-compose ps | grep -q "odoo_app.*Up.*healthy\|odoo_app.*Up" && ! ~/.docker/cli-plugins/docker-compose ps | grep -q "odoo_app.*Exit"; then
            echo "âœ… Container Ä‘ang cháº¡y bÃ¬nh thÆ°á»ng"
            echo "âœ… Container health: OK" >> ../reports/debug_info.txt
            service_available=true
          else
            echo "âŒ Container khÃ´ng healthy"
            echo "âŒ Container health: FAILED" >> ../reports/debug_info.txt
          fi
          
          echo "" >> ../reports/debug_info.txt
          echo "=== Port Status ===" >> ../reports/debug_info.txt
          ss -tulpn | grep 8069 >> ../reports/debug_info.txt 2>&1 || echo "Port 8069 not found" >> ../reports/debug_info.txt
          
          echo "ğŸ” PhÆ°Æ¡ng phÃ¡p 2: Kiá»ƒm tra port binding"
          if ss -tulpn | grep -q ":8069"; then
            echo "âœ… Port 8069 Ä‘ang Ä‘Æ°á»£c bind"
            echo "âœ… Port binding: OK" >> ../reports/debug_info.txt
            service_available=true
          else
            echo "âŒ Port 8069 khÃ´ng Ä‘Æ°á»£c bind"
            echo "âŒ Port binding: FAILED" >> ../reports/debug_info.txt
          fi
          
          echo "" >> ../reports/debug_info.txt
          echo "=== Process Check ===" >> ../reports/debug_info.txt
          echo "ğŸ” PhÆ°Æ¡ng phÃ¡p 3: Kiá»ƒm tra process Odoo trong container"
          if ~/.docker/cli-plugins/docker-compose exec -T odoo_app pgrep -f "odoo" >> ../reports/debug_info.txt 2>&1; then
            echo "âœ… Process Odoo Ä‘ang cháº¡y trong container"
            echo "âœ… Odoo process: RUNNING" >> ../reports/debug_info.txt
            service_available=true
          else
            echo "âŒ Process Odoo khÃ´ng cháº¡y trong container"
            echo "âŒ Odoo process: NOT FOUND" >> ../reports/debug_info.txt
          fi
          
          echo "" >> ../reports/debug_info.txt
          echo "=== HTTP Check ===" >> ../reports/debug_info.txt
          echo "ğŸ” PhÆ°Æ¡ng phÃ¡p 4: Kiá»ƒm tra HTTP (fallback)"
          for i in {1..3}; do
            if curl -sSf --connect-timeout 10 --max-time 30 http://localhost:8069/web/health > /dev/null 2>&1; then
              echo "âœ… HTTP health check thÃ nh cÃ´ng"
              echo "âœ… HTTP /web/health: OK (attempt $i)" >> ../reports/debug_info.txt
              service_available=true
              break
            elif curl -sSf --connect-timeout 10 --max-time 30 http://localhost:8069/ > /dev/null 2>&1; then
              echo "âœ… HTTP root check thÃ nh cÃ´ng"
              echo "âœ… HTTP /: OK (attempt $i)" >> ../reports/debug_info.txt
              service_available=true
              break
            else
              echo "âŒ HTTP attempt $i failed" >> ../reports/debug_info.txt
            fi
            echo "â³ HTTP thá»­ láº¡i láº§n $i..."
            sleep 20
          done
          
          echo "" >> ../reports/debug_info.txt
          echo "=== Container Logs (Last 30 lines) ===" >> ../reports/debug_info.txt
          ~/.docker/cli-plugins/docker-compose logs --tail 30 odoo_app >> ../reports/debug_info.txt 2>&1 || echo "Could not get container logs" >> ../reports/debug_info.txt
          
          echo "" >> ../reports/debug_info.txt
          echo "=== System Resources ===" >> ../reports/debug_info.txt
          echo "Memory usage:" >> ../reports/debug_info.txt
          free -h >> ../reports/debug_info.txt 2>&1 || true
          echo "Disk usage:" >> ../reports/debug_info.txt
          df -h >> ../reports/debug_info.txt 2>&1 || true
          
          if [ "$service_available" = true ]; then
            echo "service_available=true" >> $GITHUB_OUTPUT
            echo "âœ… Odoo service kiá»ƒm tra thÃ nh cÃ´ng"
            echo "" >> ../reports/debug_info.txt
            echo "ğŸ‰ FINAL RESULT: SERVICE AVAILABLE" >> ../reports/debug_info.txt
          else
            echo "service_available=false" >> $GITHUB_OUTPUT
            echo "âŒ Odoo service khÃ´ng pháº£n há»“i qua táº¥t cáº£ phÆ°Æ¡ng phÃ¡p"
            echo "" >> ../reports/debug_info.txt
            echo "âŒ FINAL RESULT: SERVICE NOT AVAILABLE" >> ../reports/debug_info.txt
          fi

      - name: ğŸ§¹ Cleanup Docker
        if: always()
        run: |
          cd server || true
          ~/.docker/cli-plugins/docker-compose down -v || true
          docker system prune -f || true

      - name: ğŸ“‹ Táº¡o bÃ¡o cÃ¡o CI tá»•ng há»£p
        if: always()
        run: |
          # Äáº£m báº£o táº¥t cáº£ file report tá»“n táº¡i
          touch reports/flake8_errors.txt
          touch reports/log_errors.txt
          touch reports/odoo_tail_50.txt
          touch reports/docker_ps.txt
          touch reports/debug_info.txt
          
          echo "## ğŸ“Š CI Check Results" > reports/ci_summary.txt
          echo "**Timestamp**: $(date)" >> reports/ci_summary.txt
          echo "**PR**: #${{ github.event.number }} - ${{ github.event.pull_request.title }}" >> reports/ci_summary.txt
          echo "**Branch**: ${{ github.head_ref }} â†’ develop" >> reports/ci_summary.txt
          echo "" >> reports/ci_summary.txt
          echo "### ğŸ” Káº¿t quáº£ kiá»ƒm tra:" >> reports/ci_summary.txt
          echo "- **Flake8 Check**: ${{ steps.flake8_check.outputs.has_flake8_errors == 'true' && 'âŒ CÃ³ lá»—i' || 'âœ… Passed' }}" >> reports/ci_summary.txt
          echo "- **Docker Build**: ${{ steps.docker_build.outcome == 'success' && 'âœ… Success' || 'âŒ Failed' }}" >> reports/ci_summary.txt
          echo "- **Odoo Logs**: ${{ steps.health_check.outputs.has_log_errors == 'true' && 'âŒ CÃ³ lá»—i' || 'âœ… Clean' }}" >> reports/ci_summary.txt
          echo "- **Service Check**: ${{ steps.service_check.outputs.service_available == 'true' && 'âœ… Available' || 'âŒ KhÃ´ng pháº£n há»“i' }}" >> reports/ci_summary.txt
          echo "" >> reports/ci_summary.txt
          echo "### ğŸ“ Files attached:" >> reports/ci_summary.txt
          echo "- flake8_errors.txt: Lá»—i code style" >> reports/ci_summary.txt
          echo "- log_errors.txt: Lá»—i trong Odoo logs" >> reports/ci_summary.txt
          echo "- odoo_tail_50.txt: 50 dÃ²ng log cuá»‘i cá»§a Odoo" >> reports/ci_summary.txt
          echo "- docker_ps.txt: Tráº¡ng thÃ¡i containers" >> reports/ci_summary.txt
          echo "- debug_info.txt: ThÃ´ng tin debug chi tiáº¿t" >> reports/ci_summary.txt

      - name: ğŸ“§ Gá»­i email káº¿t quáº£ CI
        if: always()
        uses: dawidd6/action-send-mail@v3
        continue-on-error: true
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: ${{ job.status == 'success' && 'âœ… CI PASSED' || 'âŒ CI FAILED' }} - PR #${{ github.event.number }}
          to: ${{ secrets.USER_CI_NOTIFY }}
          from: "Odoo CI Bot <${{ secrets.SMTP_USERNAME }}>"
          body: |
            Xin chÃ o,
            
            ğŸ” CI Report cho PR #${{ github.event.number }}: "${{ github.event.pull_request.title }}"
            
            **ğŸ“‹ ThÃ´ng tin PR:**
            - TÃ¡c giáº£: ${{ github.event.pull_request.user.login }}
            - Branch: ${{ github.head_ref }} â†’ develop
            - Commit: ${{ github.sha }}
            - Thá»i gian: $(date)
            
            **ğŸ“Š Káº¿t quáº£ chi tiáº¿t:**
            - Flake8: ${{ steps.flake8_check.outputs.has_flake8_errors == 'true' && 'âŒ CÃ³ lá»—i code style' || 'âœ… Code style OK' }}
            - Docker Build: ${{ steps.docker_build.outcome == 'success' && 'âœ… Build thÃ nh cÃ´ng' || 'âŒ Build tháº¥t báº¡i' }}
            - Odoo Logs: ${{ steps.health_check.outputs.has_log_errors == 'true' && 'âŒ CÃ³ lá»—i trong logs' || 'âœ… Logs sáº¡ch' }}
            - Service: ${{ steps.service_check.outputs.service_available == 'true' && 'âœ… Service hoáº¡t Ä‘á»™ng' || 'âš ï¸ Service khÃ´ng pháº£n há»“i (cÃ³ thá»ƒ do network)' }}
            
            ${{ job.status != 'success' && 'âš ï¸ **Cáº§n xem xÃ©t:** Vui lÃ²ng kiá»ƒm tra cÃ¡c file Ä‘Ã­nh kÃ¨m Ä‘á»ƒ biáº¿t chi tiáº¿t lá»—i.' || 'ğŸš€ **Sáºµn sÃ ng merge!** Táº¥t cáº£ kiá»ƒm tra Ä‘Ã£ pass.' }}
            
            **ğŸ”— Links:**
            - PR: ${{ github.event.pull_request.html_url }}
            - Actions: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            **ğŸ“ Files Ä‘Ã­nh kÃ¨m:**
            - ci_summary.txt: TÃ³m táº¯t káº¿t quáº£
            - debug_info.txt: ThÃ´ng tin debug chi tiáº¿t
            - CÃ¡c file logs khÃ¡c
            
            TrÃ¢n trá»ng,  
            ğŸ¤– Odoo CI Bot
          attachments: reports/ci_summary.txt,reports/debug_info.txt,reports/flake8_errors.txt,reports/log_errors.txt,reports/odoo_tail_50.txt,reports/docker_ps.txt