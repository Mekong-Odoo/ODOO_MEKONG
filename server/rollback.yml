name: ğŸ”„ Rollback Odoo

on:
  workflow_dispatch:
    inputs:
      backup_name:
        description: 'TÃªn backup Ä‘á»ƒ rollback (Ä‘á»ƒ trá»‘ng Ä‘á»ƒ xem danh sÃ¡ch)'
        required: false
        type: string
      commit_hash:
        description: 'Hoáº·c nháº­p commit hash Ä‘á»ƒ rollback'
        required: false
        type: string

jobs:
  list-backups:
    if: ${{ github.event.inputs.backup_name == '' && github.event.inputs.commit_hash == '' }}
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ” Setup SSH key
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}

      - name: ğŸ“‹ Liá»‡t kÃª backup cÃ³ sáºµn
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          echo "ğŸ“ DANH SÃCH BACKUP CÃ“ Sáº´N:"
          echo "=========================="
          
          if [ -d /home/ec2-user/odoo_backup ]; then
            cd /home/ec2-user/odoo_backup
            for backup in $(ls -t); do
              if [ -d "$backup" ]; then
                echo "ğŸ“‚ $backup"
                if [ -f "$backup/commit_hash.txt" ]; then
                  echo "   ğŸ”— Commit: $(cat $backup/commit_hash.txt)"
                fi
                echo "   ğŸ“… $(stat -c %y $backup | cut -d. -f1)"
                echo ""
              fi
            done
          else
            echo "âŒ KhÃ´ng tÃ¬m tháº¥y thÆ° má»¥c backup"
          fi
          EOF

  rollback:
    if: ${{ github.event.inputs.backup_name != '' || github.event.inputs.commit_hash != '' }}
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout source code
        if: ${{ github.event.inputs.commit_hash != '' }}
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.inputs.commit_hash }}

      - name: ğŸ” Setup SSH key
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}

      - name: ğŸ”„ Rollback báº±ng backup name
        if: ${{ github.event.inputs.backup_name != '' }}
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << EOF
          set -e
          
          BACKUP_NAME="${{ github.event.inputs.backup_name }}"
          BACKUP_DIR="/home/ec2-user/odoo_backup/\$BACKUP_NAME"
          
          echo "ğŸ” Kiá»ƒm tra backup: \$BACKUP_NAME"
          
          if [ ! -d "\$BACKUP_DIR" ]; then
            echo "âŒ KhÃ´ng tÃ¬m tháº¥y backup: \$BACKUP_NAME"
            echo "ğŸ“ CÃ¡c backup cÃ³ sáºµn:"
            ls -la /home/ec2-user/odoo_backup/ | grep "^d" | awk '{print \$9}' | grep -v "^\.$" | grep -v "^\.\.$" | sort -r
            exit 1
          fi
          
          # Táº¡o backup version hiá»‡n táº¡i (nÃ©n Ä‘á»ƒ tiáº¿t kiá»‡m)
          CURRENT_BACKUP="/home/ec2-user/odoo_backup/before_rollback_\$(date +%m%d_%H%M)"
          echo "ğŸ’¾ Backup version hiá»‡n táº¡i..."
          mkdir -p "\$CURRENT_BACKUP"
          
          if [ -d /home/ec2-user/odoo_deploy ]; then
            cd /home/ec2-user/odoo_deploy
            find . -type f \
              ! -path "*/node_modules/*" \
              ! -path "*/.git/*" \
              ! -path "*/logs/*" \
              ! -path "*/__pycache__/*" \
              ! -name "*.pyc" \
              ! -name "*.log" \
              -size -10M \
              | tar czf "\$CURRENT_BACKUP/backup.tar.gz" -T -
          fi
          
          # Dá»«ng Odoo
          echo "â¹ï¸ Dá»«ng Odoo..."
          cd /home/ec2-user/odoo_deploy
          docker-compose down 2>/dev/null || docker stop odoo_app 2>/dev/null || true
          
          # Rollback (xá»­ lÃ½ cáº£ backup nÃ©n vÃ  khÃ´ng nÃ©n)
          echo "ğŸ”„ Thá»±c hiá»‡n rollback..."
          rm -rf /home/ec2-user/odoo_deploy/*
          
          if [ -f "\$BACKUP_DIR/odoo_backup.tar.gz" ]; then
            cd /home/ec2-user/odoo_deploy
            tar xzf "\$BACKUP_DIR/odoo_backup.tar.gz"
          else
            cp -r \$BACKUP_DIR/* /home/ec2-user/odoo_deploy/
          fi
          
          # PhÃ¢n quyá»n
          cd /home/ec2-user/odoo_deploy
          chmod +x *.sh 2>/dev/null || true
          
          # Khá»Ÿi Ä‘á»™ng láº¡i
          echo "ğŸš€ Khá»Ÿi Ä‘á»™ng láº¡i Odoo..."
          ./restart-odoo.sh
          
          # Kiá»ƒm tra
          echo "â³ Kiá»ƒm tra Odoo..."
          sleep 15
          
          for i in {1..10}; do
            if curl -k -sSf https://52.221.232.143:8069 > /dev/null 2>&1 || \
               curl -k -sSf https://mekong-odoo.ddns.net:8069 > /dev/null 2>&1; then
              echo "âœ… Rollback thÃ nh cÃ´ng!"
              break
            else
              echo "â° Äang kiá»ƒm tra... (\$i/10)"
              sleep 10
            fi
          done
          
          if [ \$i -eq 10 ]; then
            echo "âŒ Rollback cÃ³ váº¥n Ä‘á», Odoo chÆ°a pháº£n há»“i"
            exit 1
          fi
          EOF

      - name: ğŸ”„ Rollback báº±ng commit hash
        if: ${{ github.event.inputs.commit_hash != '' }}
        run: |
          # Copy files tá»« commit cá»¥ thá»ƒ
          rsync -avz -e "ssh -o StrictHostKeyChecking=no" --delete server/ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/home/ec2-user/odoo_deploy_temp/
          
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          set -e
          
          echo "ğŸ”„ Rollback vá» commit: ${{ github.event.inputs.commit_hash }}"
          
          # Backup version hiá»‡n táº¡i (nÃ©n)
          CURRENT_BACKUP="/home/ec2-user/odoo_backup/before_rollback_$(date +%m%d_%H%M)"
          echo "ğŸ’¾ Backup version hiá»‡n táº¡i..."
          mkdir -p "$CURRENT_BACKUP"
          
          if [ -d /home/ec2-user/odoo_deploy ]; then
            cd /home/ec2-user/odoo_deploy
            find . -type f \
              ! -path "*/node_modules/*" \
              ! -path "*/.git/*" \
              ! -path "*/logs/*" \
              ! -path "*/__pycache__/*" \
              ! -name "*.pyc" \
              ! -name "*.log" \
              -size -10M \
              | tar czf "$CURRENT_BACKUP/backup.tar.gz" -T -
          fi
          
          echo "${{ github.event.inputs.commit_hash }}" > "$CURRENT_BACKUP/target_commit.txt"
          
          # Dá»«ng Odoo
          echo "â¹ï¸ Dá»«ng Odoo..."
          cd /home/ec2-user/odoo_deploy
          docker-compose down 2>/dev/null || docker stop odoo_app 2>/dev/null || true
          
          # Replace vá»›i code tá»« commit
          echo "ğŸ“‚ Cáº­p nháº­t code..."
          rm -rf /home/ec2-user/odoo_deploy/*
          cp -r /home/ec2-user/odoo_deploy_temp/* /home/ec2-user/odoo_deploy/
          rm -rf /home/ec2-user/odoo_deploy_temp
          
          # PhÃ¢n quyá»n vÃ  khá»Ÿi Ä‘á»™ng
          cd /home/ec2-user/odoo_deploy
          chmod +x *.sh 2>/dev/null || true
          
          echo "ğŸš€ Khá»Ÿi Ä‘á»™ng láº¡i Odoo..."
          ./restart-odoo.sh
          
          # Kiá»ƒm tra
          echo "â³ Kiá»ƒm tra Odoo..."
          sleep 15
          
          for i in {1..10}; do
            if curl -k -sSf https://52.221.232.143:8069 > /dev/null 2>&1 || \
               curl -k -sSf https://mekong-odoo.ddns.net:8069 > /dev/null 2>&1; then
              echo "âœ… Rollback thÃ nh cÃ´ng!"
              break
            else
              echo "â° Äang kiá»ƒm tra... ($i/10)"
              sleep 10
            fi
          done
          
          if [ $i -eq 10 ]; then
            echo "âŒ Rollback cÃ³ váº¥n Ä‘á»"
            exit 1
          fi
          EOF

      - name: ğŸ“§ Gá»­i email thÃ´ng bÃ¡o rollback
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: ${{ job.status == 'success' && 'ğŸ”„ ROLLBACK SUCCESS' || 'ğŸ’¥ ROLLBACK FAILED' }} - Odoo
          to: ${{ secrets.USER_DEPLOY_NOTIFY }}
          from: "Odoo Deploy Bot <${{ secrets.SMTP_USERNAME }}>"
          body: |
            Xin chÃ o,
            
            Rollback Status: ${{ job.status == 'success' && 'THÃ€NH CÃ”NG ğŸ‰' || 'THáº¤T Báº I âŒ' }}
            
            ${{ github.event.inputs.backup_name != '' && format('Backup: {0}', github.event.inputs.backup_name) || '' }}
            ${{ github.event.inputs.commit_hash != '' && format('Commit: {0}', github.event.inputs.commit_hash) || '' }}
            
            Thá»±c hiá»‡n bá»Ÿi: ${{ github.actor }}
            Thá»i gian: ${{ github.event.created_at }}
            
            Kiá»ƒm tra há»‡ thá»‘ng Odoo táº¡i:
            ğŸ”— https://52.221.232.143:8069
            ğŸ”— https://mekong-odoo.ddns.net:8069
            
            TrÃ¢n trá»ng,
            Deploy Bot