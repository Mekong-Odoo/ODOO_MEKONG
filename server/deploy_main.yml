name: üöÄ Deploy Odoo to EC2 (Incremental)

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout source code
        uses: actions/checkout@v4

      - name: üîê Setup SSH key
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}

      - name: üìã L·∫•y danh s√°ch file thay ƒë·ªïi trong th∆∞ m·ª•c server/
        id: diff
        run: |
          echo "CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '^server/' || true)" >> $GITHUB_OUTPUT

      - name: üìÇ Copy file thay ƒë·ªïi l√™n EC2
        if: steps.diff.outputs.CHANGED != ''
        run: |
          echo "${{ steps.diff.outputs.CHANGED }}" | tr ' ' '\n' > changed_files.txt
          cat changed_files.txt

          while IFS= read -r file; do
            echo "üì§ Copying $file"
            rsync -avz -e "ssh -o StrictHostKeyChecking=no" "$file" ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/home/ec2-user/odoo_deploy/"${file#server/}"
          done < changed_files.txt

      - name: üöÄ SSH v√†o EC2 v√† ti·∫øn h√†nh deploy
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            set -e
            echo "üìÇ Di chuy·ªÉn v√†o th∆∞ m·ª•c d·ª± √°n"
            cd ~/odoo_deploy

            echo "üîß Ph√¢n quy·ªÅn script"
            chmod +x restart-odoo.sh

            echo "üöÄ Kh·ªüi ƒë·ªông l·∫°i Odoo"
            ./restart-odoo.sh

            echo "üìú Xem log kh·ªüi ƒë·ªông Odoo"
            docker logs --tail=50 odoo_app || echo "‚ö†Ô∏è Kh√¥ng l·∫•y ƒë∆∞·ª£c docker logs"
            docker exec -it odoo_app tail -n 20 /var/log/odoo/odoo.log || echo "‚ö†Ô∏è Kh√¥ng l·∫•y ƒë∆∞·ª£c log trong container"

            echo "‚è≥ ƒê·ª£i Odoo ho·∫°t ƒë·ªông..."
            for i in {1..12}; do
              if curl -k -sSf https://52.221.232.143:8069 > /dev/null 2>&1 || \
                 curl -k -sSf https://mekong-odoo.ddns.net:8069 > /dev/null 2>&1; then
                echo "‚úÖ Odoo is running!"
                break
              else
                echo "‚è∞ Waiting for Odoo to start... ($i/12)"
                sleep 10
              fi
            done

            if [ $i -eq 12 ]; then
              echo "‚ùå Odoo kh√¥ng ph·∫£n h·ªìi sau 2 ph√∫t!"
              exit 1
            fi

            echo "üéâ Deploy th√†nh c√¥ng!"
          EOF

      - name: üìß G·ª≠i email th√¥ng b√°o k·∫øt qu·∫£
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: ${{ job.status == 'success' && 'üéâ DEPLOY SUCCESS' || 'üí• DEPLOY FAILED' }} - Odoo
          to: ${{ secrets.USER_DEPLOY_NOTIFY }}
          from: "Odoo Deploy Bot <${{ secrets.SMTP_USERNAME }}>"
          body: |
            Xin ch√†o,

            Deploy Status: ${{ job.status == 'success' && 'TH√ÄNH C√îNG üéâ' || 'TH·∫§T B·∫†I ‚ùå' }}
            Branch: main
            Commit: ${{ github.sha }}
            T√°c gi·∫£: ${{ github.event.pusher.name }}

            Ki·ªÉm tra h·ªá th·ªëng Odoo t·∫°i:
            - https://52.221.232.143:8069
            - https://mekong-odoo.ddns.net:8069

            Tr√¢n tr·ªçng,  
            Deploy Bot
